generator client {
  provider   = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

generator zod {
  provider = "zod-prisma-types"
}

model User {
  id              String            @id @default(auto()) @map("_id") @db.ObjectId
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  avatarUrl       String?
  badges          BadgeAssignment[]
  comments        Comment[]
  email           String            @unique
  emailVerified   Boolean           @default(false)
  evenParticipant EvenParticipant[]
  googleId        String?           @unique
  lastLogin       DateTime?
  likes           Like[]
  myEvents        Event[]           @relation("EventCreator")
  myPosts         Post[]
  name            String
  password        String?
  phoneNumber     String?
  phoneVerified   Boolean           @default(false)
  points          Int               @default(0)
  pointsHistory   PointsHistory[]
  userArticle     UserArticle[]
  username        String?           @unique
  locations       Location[]
}

model Badge {
  id          String            @id @default(auto()) @map("_id") @db.ObjectId
  criteria    String? // example: "Recycle 10 plastics"
  description String
  iconUrl     String?
  name        String
  users       BadgeAssignment[]
}

model BadgeAssignment {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  awardedAt DateTime @default(now())
  badge     Badge    @relation(fields: [badgeId], references: [id])
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  badgeId String @db.ObjectId
  userId  String @db.ObjectId
}

model Post {
  id           String        @id @default(auto()) @map("_id") @db.ObjectId
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  anonymous    Boolean       @default(false)
  author       User?         @relation(fields: [authorId], references: [id], onDelete: Cascade)
  category     String?
  comments     Comment[]
  condition    String?
  description  String
  event        Event?        @relation(fields: [eventId], references: [id], onDelete: Cascade)
  images       String[] // S3/GCS URLs or cloud storage links
  likes        Like[]
  location     Location?     @relation(fields: [locationId], references: [id])
  pickupDate   DateTime?
  tags         String[]
  title        String
  userArticles UserArticle[]

  authorId   String? @db.ObjectId
  eventId    String? @db.ObjectId
  locationId String? @db.ObjectId
}

model Like {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String   @db.ObjectId
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId    String   @db.ObjectId

  @@unique([userId, postId])
}

model Comment {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime @default(now())
  author    User?    @relation(fields: [authorId], references: [id], onDelete: Cascade)
  content   String
  post      Post     @relation(fields: [postId], references: [id])

  authorId String? @db.ObjectId
  postId   String  @db.ObjectId
}

model Event {
  id           String            @id @default(auto()) @map("_id") @db.ObjectId
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  creator      User              @relation("EventCreator", fields: [creatorId], references: [id], onDelete: Cascade)
  description  String?
  endTime      DateTime?
  imageUrl     String[]
  location     Location          @relation(fields: [locationId], references: [id])
  participants EvenParticipant[]
  posts        Post[]
  startTime    DateTime
  title        String

  creatorId  String @db.ObjectId
  locationId String @db.ObjectId
}

model EvenParticipant {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime @default(now())
  event     Event    @relation(fields: [eventId], references: [id])
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  eventId String @unique @db.ObjectId
  userId  String @db.ObjectId

  @@unique([eventId, userId])
}

model Location {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  createdAt      DateTime     @default(now())
  createdBy      User?        @relation(fields: [userId], references: [id])
  additionalInfo String?
  addressLine2   String?
  city           String?
  coordinates    Float[]
  country        String
  events         Event[]
  googlePlaceId  String?      @unique
  postalCode     String?
  posts          Post[]
  street         String
  type           LocationType

  userId String? @db.ObjectId
}

model UserArticle {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  description String?
  imageUrl    String[]
  name        String
  post        Post?    @relation(fields: [postId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  postId String? @db.ObjectId
  userId String  @db.ObjectId
}

enum LocationType {
  COLLECTION_SITE
  DISTRIBUTION_CENTER
  DONATION_CENTER
  DROP_OFF_POINT
  EVENT
  OTHER
  PICKUP_LOCATION
  RECYCLING_CENTER
  USER_CHECKIN
  USER_LOCATION
  WAREHOUSE
}

model PointsHistory {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime @default(now())
  amount    Int
  reason    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  userId String @db.ObjectId
}
