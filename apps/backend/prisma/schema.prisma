generator client {
  provider   = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

generator zod {
  provider = "zod-prisma-types"
}

model User {
  id               String            @id @default(auto()) @map("_id") @db.ObjectId
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  avatarUrl        String?
  badges           BadgeAssignment[]
  blockedUsers     UserBlock[]       @relation("Blocker")
  blockedByUsers   UserBlock[]       @relation("Blocked")
  chatReports      ChatReport[]
  comments         Comment[]
  chatsAsRequester Chat[]            @relation("ChatRequester")
  chatsAsAuthor    Chat[]            @relation("ChatAuthor")
  sentMessages     ChatMessage[]
  email            String            @unique
  emailVerified    Boolean           @default(false)
  evenParticipant  EvenParticipant[]
  googleId         String?           @unique
  lastLogin        DateTime?
  likes            Like[]
  myEvents         Event[]           @relation("EventCreator")
  myPosts          Post[]
  name             String
  password         String?
  phoneNumber      String?
  phoneVerified    Boolean           @default(false)
  points           Int               @default(0)
  pointsHistory    PointsHistory[]
  userArticle      UserArticle[]
  username         String?           @unique
  fcmToken         String?
  locations        Location[]
}

model Badge {
  id          String            @id @default(auto()) @map("_id") @db.ObjectId
  criteria    String? // example: "Recycle 10 plastics"
  description String
  iconUrl     String?
  name        String
  users       BadgeAssignment[]
}

model BadgeAssignment {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  awardedAt DateTime @default(now())
  badge     Badge    @relation(fields: [badgeId], references: [id])
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  badgeId String @db.ObjectId
  userId  String @db.ObjectId
}

model Post {
  id           String        @id @default(auto()) @map("_id") @db.ObjectId
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  anonymous    Boolean       @default(false)
  author       User?         @relation(fields: [authorId], references: [id], onDelete: Cascade)
  category     String?
  comments     Comment[]
  chats        Chat[]
  condition    String?
  description  String
  event        Event?        @relation(fields: [eventId], references: [id], onDelete: Cascade)
  images       String[] // S3/GCS URLs or cloud storage links
  likes        Like[]
  location     Location?     @relation(fields: [locationId], references: [id])
  pickupDate   DateTime?
  postType     PostType      @default(GIVEAWAY)
  tags         String[]
  title        String
  userArticles UserArticle[]

  authorId   String? @db.ObjectId
  eventId    String? @db.ObjectId
  locationId String? @db.ObjectId
}

model Like {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String   @db.ObjectId
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId    String   @db.ObjectId

  @@unique([userId, postId])
}

model Comment {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime @default(now())
  author    User?    @relation(fields: [authorId], references: [id], onDelete: Cascade)
  content   String
  post      Post     @relation(fields: [postId], references: [id])

  authorId String? @db.ObjectId
  postId   String  @db.ObjectId
}

model Chat {
  id        String        @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  post      Post          @relation(fields: [postId], references: [id], onDelete: Cascade)
  requester User          @relation("ChatRequester", fields: [requesterId], references: [id], onDelete: Cascade)
  author    User          @relation("ChatAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  messages  ChatMessage[]
  reports   ChatReport[]

  postId      String @db.ObjectId
  requesterId String @db.ObjectId
  authorId    String @db.ObjectId

  @@unique([postId, requesterId])
}

model ChatMessage {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime @default(now())
  chat      Chat     @relation(fields: [chatId], references: [id], onDelete: Cascade)
  sender    User     @relation(fields: [senderId], references: [id], onDelete: Cascade)
  content   String

  chatId   String @db.ObjectId
  senderId String @db.ObjectId
}

model ChatReport {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime @default(now())
  reporter  User     @relation(fields: [reporterId], references: [id], onDelete: Cascade)
  chat      Chat     @relation(fields: [chatId], references: [id], onDelete: Cascade)
  reason    String

  reporterId String @db.ObjectId
  chatId     String @db.ObjectId

  @@unique([reporterId, chatId])
}

model UserBlock {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime @default(now())
  blocker   User     @relation("Blocker", fields: [blockerId], references: [id], onDelete: Cascade)
  blocked   User     @relation("Blocked", fields: [blockedId], references: [id], onDelete: Cascade)

  blockerId String @db.ObjectId
  blockedId String @db.ObjectId

  @@unique([blockerId, blockedId])
}

model Event {
  id           String            @id @default(auto()) @map("_id") @db.ObjectId
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  creator      User              @relation("EventCreator", fields: [creatorId], references: [id], onDelete: Cascade)
  description  String?
  endTime      DateTime?
  imageUrl     String[]
  location     Location          @relation(fields: [locationId], references: [id])
  participants EvenParticipant[]
  posts        Post[]
  startTime    DateTime
  title        String

  creatorId  String @db.ObjectId
  locationId String @db.ObjectId
}

model EvenParticipant {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime @default(now())
  event     Event    @relation(fields: [eventId], references: [id])
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  eventId String @unique @db.ObjectId
  userId  String @db.ObjectId

  @@unique([eventId, userId])
}

model Location {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  createdAt      DateTime     @default(now())
  createdBy      User?        @relation(fields: [userId], references: [id])
  additionalInfo String?
  addressLine2   String?
  city           String?
  coordinates    Float[]
  country        String
  events         Event[]
  googlePlaceId  String?      @unique
  postalCode     String?
  posts          Post[]
  street         String
  type           LocationType

  userId String? @db.ObjectId
}

model UserArticle {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  description String?
  imageUrl    String[]
  name        String
  post        Post?    @relation(fields: [postId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  postId String? @db.ObjectId
  userId String  @db.ObjectId
}

enum LocationType {
  COLLECTION_SITE
  DISTRIBUTION_CENTER
  DONATION_CENTER
  DROP_OFF_POINT
  EVENT
  OTHER
  PICKUP_LOCATION
  RECYCLING_CENTER
  USER_CHECKIN
  USER_LOCATION
  WAREHOUSE
}

enum PostType {
  GIVEAWAY
  REQUESTS
}

model PointsHistory {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime @default(now())
  amount    Int
  reason    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  userId String @db.ObjectId
}
